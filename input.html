<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxtwlajG20K1PJXjwrctoZFr6aNaqoq923J7cq9ybZMmyRZU4oMyTj-IBKBfD58UEM-fQ/exec";
    const userKel = localStorage.getItem("kelurahan");
    
    if(!userKel) window.location.href = "index.html";
    document.getElementById("namaKel").innerText = userKel;

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL + "?t=" + Date.now());
            const rawData = await res.json();
            
            // PERBAIKAN PEMETAAN: Sesuaikan dengan Header di Gambar Sheets Anda
            const data = rawData.map(item => ({
                timestamp: item["Timestamp"],
                kelurahan: item["Kelurahan"],
                bidang: item["Bidang Program"], // Sesuai kolom C
                kegiatan: item["Nama Kegiatan"], // Sesuai kolom D
                lokasi: item["Lokasi"],         // Sesuai kolom E
                volume: item["Volume"],         // Sesuai kolom F
                anggaran: item["Anggaran"],     // Sesuai kolom G
                opd: item["OPD Tujuan"],       // Sesuai kolom H
                keterangan: item["Keterangan"]   // Sesuai kolom I
            }));

            // Filter berdasarkan kelurahan yang sedang login
            const filtered = data.filter(d => d.kelurahan === userKel);
            let html = "";
            
            if (filtered.length === 0) {
                html = "<tr><td colspan='8' style='text-align:center'>Belum ada usulan terdaftar untuk wilayah ini.</td></tr>";
            } else {
                filtered.forEach(d => {
                    html += `<tr>
                        <td>${d.bidang || '-'}</td>
                        <td><strong>${d.kegiatan || '-'}</strong></td>
                        <td>${d.lokasi || '-'}</td>
                        <td>${d.volume || '-'}</td>
                        <td>Rp ${Number(d.anggaran || 0).toLocaleString('id-ID')}</td>
                        <td>${d.opd || '-'}</td>
                        <td>${d.keterangan || '-'}</td>
                        <td class="no-print">
                            <button onclick="hapus('${d.timestamp}')" style="color:#dc3545; cursor:pointer; border:1px solid #dc3545; background:none; border-radius:4px; padding:4px 8px; font-size:11px;">Hapus</button>
                        </td>
                    </tr>`;
                });
            }
            document.getElementById("isiTabel").innerHTML = html;
        } catch (e) {
            document.getElementById("isiTabel").innerHTML = "<tr><td colspan='8' style='text-align:center; color:red'>Gagal memuat data. Periksa koneksi internet.</td></tr>";
        }
    }

    function exportExcel() {
        const table = document.getElementById("tabelData");
        const clone = table.cloneNode(true);
        clone.querySelectorAll('.no-print').forEach(el => el.remove());
        const wb = XLSX.utils.table_to_book(clone, {sheet: "Daftar Usulan"});
        XLSX.writeFile(wb, `Usulan_${userKel}_2027.xlsx`);
    }

    document.getElementById("formUsulan").onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnProses");
        btn.innerText = "Mengirim..."; btn.disabled = true;

        const payload = {
            action: "insert",
            kelurahan: userKel,
            "Bidang Program": document.getElementById("bidang").value,
            "Nama Kegiatan": document.getElementById("kegiatan").value,
            "Lokasi": document.getElementById("lokasi").value,
            "Volume": document.getElementById("volume").value,
            "Anggaran": document.getElementById("anggaran").value,
            "OPD Tujuan": document.getElementById("opd").value,
            "Keterangan": document.getElementById("keterangan").value
        };

        try {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("Usulan Berhasil Terkirim!");
            location.reload();
        } catch (err) {
            alert("Gagal mengirim usulan.");
            btn.innerText = "KIRIM USULAN"; btn.disabled = false;
        }
    };

    async function hapus(id) {
        if(confirm("Apakah Anda yakin ingin menghapus usulan ini?")) {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({action:"delete", rowId: id}) });
            loadData();
        }
    }

    loadData();
</script>